# 프롬프트 필터링 방안

## 1) 목표와 위협 모델
- **목표:** 모델 앞단에서 “입력(프롬프트)”을 표준화·검사·재작성하여 **데이터 유출·규정 위반·프롬프트 인젝션**을 사전에 차단.
- **대표 위협**
  - 프롬프트 인젝션 / 규칙 무력화(“이전 지시 무시하고…”)
  - **PII/비밀정보 반출**(키, 인증서, 주민번호, 내부 코드/문서)
  - 악성 컨텍스트 주입(첨부 문서/URL의 악성 지시)
  - 컴플라이언스 위반(증오·조장, 불법 행위 요청 등)

## 2) 프록시 아키텍처(권장 파이프라인)
```
[Client]
   ↓ ①인증·식별(RBAC, 토큰, 테넌트)
[LLM Proxy/Gateway]
   ↓ ②입력 정규화(Normalize/Decode)
   ↓ ③정책 엔진(Allow/Deny/Transform)
        - Rule 기반(Regex/패턴/키워드/스코어)
        - ML/LLM 기반 분류(안전성/인젝션/PII)
        - DLP/시크릿 스캐너 연동
        - 임베딩 유사도 기반 금칙 표현
   ↓ ④Sanitizer(마스킹/재작성/컨텍스트 격리)
   ↓ ⑤감사 로깅·샌드박스(샘플링·리플레이)
   ↓ ⑥백엔드 LLM(사내/클라우드)
   ↓ ⑦출력 필터(응답 안전성·PII 재점검)
[Client]
```

## 3) 필터링 레이어 설계
(정적 필터, 시크릿·PII·DLP, 인젝션 탐지, ML 기반 분류, 임베딩 기반 필터, Sanitizer)

## 4) 정책 엔진(YAML 예시)
```yaml
version: 1
tenants:
  - id: "kra-internal"
    rules:
      deny_patterns:
        - "(?i)ignore (all )?previous (instructions|rules)"
        - "(?i)admin(istrator)?\s+password"
      pii:
        - national_id.kr
        - credit_card
      secrets:
        - aws_access_key
        - oauth_token
      dlp:
        doc_class_denied: ["Confidential", "Restricted"]
      embedding_blocklists: ["jailbreak_set_v2"]
    actions:
      suspicious: "sanitize"
      pii_found: "mask"
      secrets_found: "block"
      default: "allow"
```

## 5) 구현 패턴(FastAPI 예시)
```python
from fastapi import FastAPI, Request, HTTPException

app = FastAPI()

@app.middleware("http")
async def prompt_filter(request: Request, call_next):
    if request.url.path != "/v1/chat/completions":
        return await call_next(request)

    body = await request.json()
    user_prompt = body.get("messages", [])[-1]["content"]

    if "password" in user_prompt.lower():
        raise HTTPException(400, "금지된 정보가 포함되어 차단되었습니다.")

    resp = await call_next(request)
    return resp
```

## 6) 성능·운영 체크리스트
- 지연 예산 관리
- Fail 모드(Fail-Closed)
- 로깅 최소화(요약/해시)

## 7) 오픈소스/컴포넌트 라이선스 및 도입 분석 (2025-09-26)

| 영역 | 컴포넌트 | 주요 역할 | 라이선스 | 자체 호스팅 | 비고/리스크 |
|---|---|---|---|---|---|
| PII | Microsoft Presidio | PII 탐지/마스킹 | MIT | 가능 | 성숙, 도커 제공 |
| 시크릿 | TruffleHog | 비밀 검출 | AGPL-3.0 | 가능 | 강한 카피레프트 |
| 시크릿 | Gitleaks | 비밀 검출 | MIT | 가능 | 경량, CI 용이 |
| 시크릿 | detect-secrets | 비밀 검출 | Apache-2.0 | 가능 | 파이썬 플러그인 |
| 프롬프트 가드 | Guardrails AI | 출력 검증 | Apache-2.0 | 가능 | 관리형 옵션 있음 |
| 프롬프트 가드 | Rebuff | 인젝션 탐지 | Apache-2.0 | 가능 | 2025-05 아카이브됨 |
| 패턴매칭 | Vectorscan | 고성능 매칭 | BSD-3 | 가능 | Hyperscan 대안 |
| 임베딩 | sentence-transformers | 임베딩 모델 | Apache-2.0 | 가능 | Hugging Face |
| 벡터 검색 | FAISS | 벡터 인덱스 | MIT | 가능 | GPU 지원 |
| 벡터DB | Qdrant | 벡터DB | Apache-2.0 | 가능 | 클러스터링 지원 |
| 게이트웨이 | Envoy Proxy | L7 프록시 | Apache-2.0 | 가능 | ExtAuthz 연동 |
| 게이트웨이 | NGINX OSS | 리버스 프록시 | BSD-2 | 가능 | 경량 |
| 정책엔진 | Open Policy Agent | Rego 정책 | Apache-2.0 | 가능 | CNCF Graduated |
| 검색 | OpenSearch | 로그/검색 | Apache-2.0 | 가능 | Elastic 포크 |
| 검색 | Elasticsearch | 로그/검색 | AGPL 옵션 | 가능 | 법무 검토 필요 |

### 권장 스택
- 퍼미시브 전용: Presidio + Gitleaks/detect-secrets + Vectorscan + FAISS/Qdrant + Envoy/OPA + Guardrails

