"use strict";exports.id=120,exports.ids=[120],exports.modules={4120:(e,r,t)=>{t.d(r,{Gg:()=>getUserAccountFromDb,PT:()=>refreshUserApikeyInDb,X_:()=>getUserStats,fJ:()=>logAttempt});var o=t(2201),s=t(9492);let createNewAccountInDb=async e=>{let{data:r,error:t}=await s.oY.from("accounts").insert({id:e.id,user_apikey:(0,o.Z)(),name:e.email,credits_total_cents_10k:1e3}).select("*");if(t)throw console.error(`Error creating account for user ${e.id}`),console.error(t),t;return{apikey:r[0].user_apikey,credits:r[0].credits_total_cents_10k}},getUserAccountFromDb=async e=>{let{data:r,error:t}=await s.oY.from("accounts").select("user_apikey, credits_total_cents_10k").eq("id",e.id).single();if(t&&t?.code==="PGRST116")return console.log("No account found for user, creating new account"),createNewAccountInDb(e);if(t)throw console.error("Error getting account for user"),console.error(t),t;return{apikey:r.user_apikey,credits:r.credits_total_cents_10k}},refreshUserApikeyInDb=async(e,r)=>{let{error:t}=await s.oY.from("accounts").update({user_apikey:r}).eq("id",e.id);if(t)throw console.error(`Error updating apikey for user ${e.id}`),console.error(t),Error("Error updating apikey")},getUserStats=async e=>{let{data:r,error:t}=await s.oY.rpc("get_attempt_aggregates",{user_id:e.id});if(t)throw console.error(`Error getting stats for user ${e.id}`),console.error(t),Error("Error getting stats");let updateObjectValues=(e,r)=>{for(let t in e)r.hasOwnProperty(t)&&("number"==typeof r[t]&&isFinite(r[t])?e[t]=r[t]:"object"==typeof r[t]&&"object"==typeof e[t]&&updateObjectValues(e[t],r[t]));return e};return updateObjectValues({breaches:{total:0,user:0},detections:0,requests:0},r)},logAttempt=async(e,r,t)=>{let{error:o}=await s.oY.from("attempts").insert({user_id:e.id,request:r,response:t,breach:t.breach});if(o)throw console.error(`Error logging attempt for user ${e.id}`),console.error(o),o}},2201:(e,r,t)=>{t.d(r,{Z:()=>generateApiKey});var o=t(6113);function generateApiKey(e=64){let r=Math.ceil(e/2),t=(0,o.randomBytes)(r).toString("hex");return t.substring(0,e)}}};