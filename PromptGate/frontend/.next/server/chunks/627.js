"use strict";exports.id=627,exports.ids=[627],exports.modules={9627:(e,s,r)=>{r.d(s,{r4:()=>checkApiKey,Ec:()=>checkApiKeyAndReduceBalance,UE:()=>runMiddleware});var t=r(4379);if(!process.env.PINECONE_ENVIRONMENT||!process.env.PINECONE_API_KEY)throw Error("Pinecone environment or api key vars missing");(async function(){try{let e=new t.PineconeClient;await e.init({environment:process.env.PINECONE_ENVIRONMENT??"",apiKey:process.env.PINECONE_API_KEY??""})}catch(e){throw console.log("error",e),Error("Failed to initialize Pinecone Client")}})(),r(7747);var n=r(9492),c=r(3118),i=r(9401);function runMiddleware(e,s,r){return new Promise((t,n)=>{r(e,s,e=>e instanceof Error?n(e):t(e))})}async function deductCredits(e,s){let{data:r,error:t}=await n.oY.rpc("deduct_rate",{input_api_key:e,rate:s});return t?(console.log("Error in deduct_rate:",t),{success:!1,message:"Invalid API key or insufficient credits"}):r?r<=0?(console.log("Error in deduct_rate: no credits left"),{success:!1,message:"Insufficient credits"}):{success:!0,message:"API key accepted and credits deducted"}:(console.log("Error in deduct_rate: no data returned"),{success:!1,message:"Error processing request"})}async function checkApiKeyAndReduceBalance(e){let s=parseInt((0,i.lS)("BILLING_RATE_INT_10K"));if(process.env.MASTER_API_KEY&&e===process.env.MASTER_API_KEY){if(!process.env.MASTER_CREDIT_AMOUNT)return{success:!1,message:"Master API key defined but no master credit amount"};let e=parseInt((0,i.lS)("MASTER_CREDIT_AMOUNT"));if(e>=s)return{success:!0,message:"Master API key accepted"};if(e<s)return{success:!1,message:"Master API key has insufficient credits"}}return deductCredits(e,s)}async function checkApiKey(e){if(process.env.MASTER_API_KEY&&e===process.env.MASTER_API_KEY)return{success:!0,message:"Master API key accepted"};let{data:s,error:r}=await n.oY.from("accounts").select("id").eq("user_apikey",e);return r||!s?{success:!1,message:"Invalid API key"}:{success:!0,message:"API key accepted",account_id:s[0].id}}new c.OpenAIApi(new c.Configuration({apiKey:(0,i.lS)("OPENAI_API_KEY")})),function(){let e=["","prior","previous","preceding","above","foregoing","earlier","initial"],s=["","and start over","and start anew","and begin afresh","and start from scratch"],r=["content","text","instructions","instruction","directives","directive","commands","command","context","conversation","input","inputs","data","message","messages","communication","response","responses","request","requests"],t=[];for(let n of["Ignore","Disregard","Skip","Forget","Neglect","Overlook","Omit","Bypass","Pay no attention to","Do not follow","Do not obey"])for(let c of e)for(let e of r)for(let r of s)t.push(`${n} ${c} ${e} ${r}`.trim())}()}};