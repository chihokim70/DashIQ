"use strict";(()=>{var e={};e.id=991,e.ids=[991],e.modules={4379:e=>{e.exports=require("@pinecone-database/pinecone")},4001:e=>{e.exports=require("@supabase/auth-helpers-nextjs")},2885:e=>{e.exports=require("@supabase/supabase-js")},1030:e=>{e.exports=require("abort-controller")},9834:e=>{e.exports=require("agentkeepalive")},1615:e=>{e.exports=require("camelcase")},9351:e=>{e.exports=require("chromadb")},3582:e=>{e.exports=require("cors")},7904:e=>{e.exports=require("decamelize")},5755:e=>{e.exports=require("flat")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},3118:e=>{e.exports=require("openai")},6998:e=>{e.exports=require("p-queue")},1917:e=>{e.exports=require("p-retry")},7747:e=>{e.exports=require("string-similarity")},3143:e=>{e.exports=require("whatwg-url")},1168:e=>{e.exports=import("data-uri-to-buffer")},4091:e=>{e.exports=import("fetch-blob")},1034:e=>{e.exports=import("fetch-blob/from.js")},5735:e=>{e.exports=import("form-data-encoder")},2962:e=>{e.exports=import("formdata-node")},7083:e=>{e.exports=import("formdata-node/file-from-path")},1691:e=>{e.exports=import("formdata-polyfill/esm.min.js")},1667:e=>{e.exports=import("langsmith")},6555:e=>{e.exports=import("uuid")},6113:e=>{e.exports=require("crypto")},3685:e=>{e.exports=require("http")},5687:e=>{e.exports=require("https")},2254:e=>{e.exports=require("node:buffer")},7561:e=>{e.exports=require("node:fs")},8849:e=>{e.exports=require("node:http")},2286:e=>{e.exports=require("node:https")},7503:e=>{e.exports=require("node:net")},4492:e=>{e.exports=require("node:stream")},1041:e=>{e.exports=require("node:url")},7261:e=>{e.exports=require("node:util")},5628:e=>{e.exports=require("node:zlib")},2781:e=>{e.exports=require("stream")},7310:e=>{e.exports=require("url")},9796:e=>{e.exports=require("zlib")},5994:(e,r,o)=>{o.a(e,async(e,t)=>{try{o.r(r),o.d(r,{config:()=>l,default:()=>u,routeModule:()=>c});var a=o(1802),s=o(7153),n=o(6249),i=o(6797),p=e([i]);i=(p.then?(await p)():p)[0];let u=(0,n.l)(i,"default"),l=(0,n.l)(i,"config"),c=new a.PagesAPIRouteModule({definition:{kind:s.x.PAGES_API,page:"/api/playground",pathname:"/api/playground",bundlePath:"",filename:""},userland:i});t()}catch(e){t(e)}})},6797:(e,r,o)=>{o.a(e,async(e,t)=>{try{o.r(r),o.d(r,{default:()=>handler});var a=o(3118),s=o(3582),n=o.n(s),i=o(9492),p=o(4120),u=o(3430),l=o(9401),c=e([u]);u=(c.then?(await c)():c)[0];let d=n()({methods:["POST","GET","HEAD"]}),m=new a.OpenAIApi(new a.Configuration({apiKey:process.env.OPENAI_API_KEY}));async function callOpenAiToGetSQLQuery(e){let r=await (0,l.gU)(e),o=await m.createChatCompletion({model:"gpt-3.5-turbo",messages:[{role:"user",content:r}]});if(void 0===o.data.choices[0].message)return console.log("completion.data.choices[0].message is undefined"),{completion:"",error:Error("server_error")};if(0===o.data.choices.length)return console.log("completion.data.choices.length === 0"),{completion:"",error:Error("server_error")};let t=o.data.choices[0].message.content;return{completion:t,error:null}}let checkSqlBreach=e=>{let r=e.toLowerCase();return!!(r.includes("insert")||r.includes("update")||r.includes("delete")||r.includes("users")||r.includes("passwords"))};async function getResponse(e,r,o,t,a,s,n,i){if(!("string"==typeof r&&"boolean"==typeof o&&"boolean"==typeof t&&"boolean"==typeof a&&"number"==typeof s&&"number"==typeof n&&"number"==typeof i))throw Error("Invalid payload");let p=(0,l.lS)("REBUFF_API")||void 0,c=new u.J({apiKey:e,apiUrl:p}),d=await c.detectInjection({userInput:r,maxHeuristicScore:s,maxVectorScore:i,maxModelScore:n,runHeuristicCheck:o,runVectorCheck:t,runLanguageModelCheck:a});if(d.injectionDetected)return{detection:d,breach:!1,output:"Prompt injection detected",canary_word:"",canary_word_leaked:!1};let[m,h]=c.addCanaryWord(r),f=await (0,l.Cm)(5e3,callOpenAiToGetSQLQuery(m),e=>"string"==typeof e.completion&&e.completion.length>0);if(!f.completion)throw console.error("No response from LLM"),f.error&&console.error(f.error),Error("No response from LLM");let x=c.isCanaryWordLeaked(r,f.completion,h),g=checkSqlBreach(f.completion);return g&&(console.log("SQL breach detected!"),await c.logLeakage(r,{completion:f.completion,canary_word:h})),{detection:d,breach:x||g,output:f.completion,canary_word:h,canary_word_leaked:x}}async function handler(e,r){let o;if(await new Promise((o,t)=>{d(e,r,e=>e instanceof Error?t(e):o(e))}),"POST"!==e.method)return r.status(405).json({error:"not_allowed",message:"Method not allowed"});try{if(!(o=await (0,i.A6)(e,r)))throw Error("unauthorized")}catch(e){return r.status(401).json({error:"unauthorized",message:"Unauthorized"})}try{let{userInput:t,runHeuristicCheck:a=!0,runVectorCheck:s=!0,runLanguageModelCheck:n=!0,maxHeuristicScore:i=.75,maxModelScore:u=.9,maxVectorScore:l=.9}=e.body,{apikey:c}=await (0,p.Gg)(o),d=await getResponse(c,t,a,s,n,i,u,l);return(0,p.fJ)(o,{apikey:c,userInput:t,runHeuristicCheck:a,runVectorCheck:s,runLanguageModelCheck:n,maxHeuristicScore:i,maxModelScore:u,maxVectorScore:l},d),r.status(200).json(d)}catch(e){return console.error(e),r.status(500).json({error:"server_error",message:"something went wrong"})}}t()}catch(e){t(e)}})}};var r=require("../../webpack-api-runtime.js");r.C(e);var __webpack_exec__=e=>r(r.s=e),o=r.X(0,[222,430,492,120],()=>__webpack_exec__(5994));module.exports=o})();